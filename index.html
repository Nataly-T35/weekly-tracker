<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ù–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{--bg:#f6f7fb;--card:#fff;--accent:#2563eb;--ok:#16a34a;--muted:#6b7280}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111;padding:16px;max-width:760px;margin-left:auto;margin-right:auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{font-size:18px;margin:0;padding:0}
.card{background:var(--card);border-radius:12px;padding:12px;margin-top:12px;box-shadow:0 1px 0 rgba(0,0,0,0.04)}
.controls{display:flex;gap:8px}
input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:15px}
button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;font-size:15px}
.small{background:transparent;color:var(--accent);padding:6px;border-radius:8px;border:1px solid rgba(59,130,246,0.18)}
.today-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px;font-size:14px;color:var(--muted)}
.weekdays{display:flex;gap:6px;justify-content:center;margin-top:8px}
.weekday{padding:6px 8px;border-radius:8px;background:#fff;border:1px solid #eee;font-size:13px}
.weekday.today{background:var(--accent);color:#fff;border-color:transparent}
.habit{margin-bottom:14px}
.habit-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.weeks-scroll{overflow:auto;padding:8px 0}
.weeks{display:flex;gap:6px;flex-wrap:nowrap}
.week-cell{min-width:78px;flex:0 0 auto;border-radius:10px;background:#f3f4f6;padding:8px;text-align:center;font-size:12px;color:#111;cursor:pointer;border:1px solid #eee}
.week-cell.done{background:var(--ok);color:#fff;border-color:transparent}
.week-cell.current{box-shadow:0 0 0 2px rgba(34,197,94,0.12)}
.stats{font-size:13px;color:var(--muted);margin-top:8px}
.progress{height:8px;background:#e6eefc;border-radius:8px;overflow:hidden;margin-top:8px}
.progress > div{height:100%;background:var(--accent);width:0%}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.footer{font-size:13px;color:var(--muted);text-align:center;margin-top:12px;padding-bottom:30px}
.icon-btn{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:8px}
@media (max-width:420px){.week-cell{min-width:64px;font-size:11px;padding:6px}}
</style>
</head>
<body>
<div class="header">
  <h1>üìÖ –ù–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</h1>
  <div style="text-align:right">
    <div style="font-size:12px;color:var(--muted)">–õ–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
  </div>
</div>

<div class="card">
  <div class="controls">
    <input id="habitInput" placeholder="–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–ø–æ—Ä—Ç, –º–µ–¥–∏—Ç–∞—Ü–∏—è)" />
    <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <div class="today-row" id="todayRow"></div>
  <div class="hint">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª–µ—Ç–∫—É –Ω–µ–¥–µ–ª–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é.</div>
</div>

<div id="list"></div>

<div class="footer">
  <div>–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ Safari ‚Üí –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ ¬´–î–æ–º–æ–π¬ª¬ª</div>
  <div style="margin-top:6px">PWA-–æ–ø—ã—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ HTTPS (GitHub Pages / Netlify)</div>
</div>

<script>
/* ---------- —Ö—Ä–∞–Ω–µ–Ω–∏–µ ---------- */
const KEY = "week-tracker-v2";
let store = JSON.parse(localStorage.getItem(KEY) || "null");
if(!store){ store = { habits: [] }; localStorage.setItem(KEY, JSON.stringify(store)); }
function save(){ localStorage.setItem(KEY, JSON.stringify(store)); }

/* ---------- –¥–∞—Ç—ã ---------- */
function mondayOf(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
function keyFor(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function fmtShort(d){ return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'short'}); }

/* ---------- –Ω–µ–¥–µ–ª–∏ ---------- */
const WEEKS = 52;
const now = new Date();
const currentMon = mondayOf(now);
const weeks = [];
for(let i=WEEKS-1;i>=0;i--){
  const d = new Date(currentMon); d.setDate(d.getDate()-i*7); weeks.push(d);
}
const today = new Date();

/* ---------- —Ä–µ–Ω–¥–µ—Ä "—Å–µ–≥–æ–¥–Ω—è" (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫..–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ) ---------- */
function renderTodayRow(){
  const row = document.getElementById('todayRow');
  row.innerHTML = '';
  const start = mondayOf(today);
  const names = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
  const weekdays = document.createElement('div'); weekdays.className='weekdays';
  for(let i=0;i<7;i++){
    const d = new Date(start); d.setDate(d.getDate()+i);
    const el = document.createElement('div');
    el.className = 'weekday' + (d.toDateString()===today.toDateString() ? ' today' : '');
    el.textContent = names[i] + ' ' + String(d.getDate()).padStart(2,'0');
    weekdays.appendChild(el);
  }
  row.appendChild(weekdays);
}

/* ---------- UI –∏ –ª–æ–≥–∏–∫–∞ ---------- */
const listEl = document.getElementById('list');
const input = document.getElementById('habitInput');
document.getElementById('addBtn').addEventListener('click', ()=>{ const name=input.value.trim(); if(!name) return; store.habits.unshift({ id:Date.now(), name, log:{} }); input.value=''; save(); render(); });

function toggleWeek(hId, weekKey){
  const h = store.habits.find(x=>x.id===hId); if(!h) return;
  h.log[weekKey] = !h.log[weekKey];
  if(!h.log[weekKey]) delete h.log[weekKey];
  save(); render();
}
function removeHabit(hId){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É?')) return;
  store.habits = store.habits.filter(x=>x.id!==hId); save(); render();
}

function computeStats(h){
  const keys = weeks.map(w=>keyFor(w));
  let done=0;
  for(const k of keys) if(h.log[k]) done++;
  const percent = keys.length ? Math.round(done/keys.length*100) : 0;
  let streak=0;
  for(let i=keys.length-1;i>=0;i--){
    if(h.log[keys[i]]) streak++; else break;
  }
  return { total: keys.length, done, percent, streak };
}

function render(){
  renderTodayRow();
  listEl.innerHTML = '';
  if(store.habits.length===0){
    const c=document.createElement('div'); c.className='card'; c.innerHTML='<div style="color:var(--muted)">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –≤—ã—à–µ.</div>'; listEl.appendChild(c); return;
  }
  const currentWeekKey = keyFor(mondayOf(new Date()));
  for(const h of store.habits){
    const card = document.createElement('div'); card.className='card habit';
    const stats = computeStats(h);
    const header = document.createElement('div'); header.className='habit-header';
    header.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><strong>${escapeHtml(h.name)}</strong>
      <div style="font-size:13px;color:var(--muted)">${stats.done}/${stats.total} ‚Ä¢ ${stats.percent}% ‚Ä¢ üî• ${stats.streak}</div></div>
      <div style="display:flex;gap:8px">
        <button class="icon-btn" onclick="markThis(${h.id})">‚úî –≠—Ç–∞ –Ω–µ–¥–µ–ª—è</button>
        <button class="icon-btn" onclick="removeThis(${h.id})">–£–¥–∞–ª–∏—Ç—å</button>
      </div>`;
    card.appendChild(header);

    const scroll = document.createElement('div'); scroll.className='weeks-scroll';
    const weeksWrap = document.createElement('div'); weeksWrap.className='weeks';
    for(const w of weeks){
      const k = keyFor(w);
      const cell = document.createElement('div');
      let cls = 'week-cell' + (h.log[k] ? ' done' : '');
      if(k===currentWeekKey) cls += ' current';
      cell.className = cls;
      cell.title = `${fmtShort(w)} ‚Äî ${k}`;
      cell.innerHTML = `<div style="font-weight:600">${fmtShort(w)}</div><div style="font-size:11px;color:var(--muted)">${w.getFullYear()}</div>`;
      cell.onclick = ((hid, key)=>()=> toggleWeek(hid, key))(h.id, k);
      weeksWrap.appendChild(cell);
    }
    scroll.appendChild(weeksWrap);
    card.appendChild(scroll);

    const prog = document.createElement('div'); prog.className='progress';
    const bar = document.createElement('div'); bar.style.width = stats.percent + '%';
    prog.appendChild(bar);
    card.appendChild(prog);

    const hint = document.createElement('div'); hint.className='stats'; hint.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª–µ—Ç–∫—É, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é. –ó–µ–ª–µ–Ω–∞—è ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è –ø–æ–¥—Å–≤–µ—á–µ–Ω–∞.';
    card.appendChild(hint);

    listEl.appendChild(card);
  }

  window.markThis = (id) => toggleWeek(id, currentWeekKey);
  window.removeThis = (id) => removeHabit(id);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

render();
setInterval(()=>{ const d=new Date(); if(d.toDateString()!==today.toDateString()){ location.reload(); } }, 60*1000);

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')).catch(()=>{});
}
</script>
</body>
</html>
